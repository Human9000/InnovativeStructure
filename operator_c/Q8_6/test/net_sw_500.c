#include "../h_sw/layer.h"

i8 d1_w[48] = {64, 64, -64, -64, -64, 64, 64, 64, 64, 64, 64, 64, 64, 64, -64, -64, 64, 64, -64, -64, 9, 64, 64, 64, -64, -64, 64, 64, -64, -64, 64, -35, -64, -64, -64, -64, 64, -64, 47, -64, 64, -64, 64, -64, -64, -64, 64, 64};
i8 d2_w[48] = {28, 64, -64, 64, -53, -64, 64, 48, -9, -64, 64, -64, 24, 64, -64, 64, -64, -64, 64, 64, -64, -64, 64, -64, -53, 7, -40, 19, -17, -50, 3, 34, 64, -64, 64, -64, -64, -64, 64, -64, 26, -64, 64, 64, 64, -64, -64, -64};
b8 d3_w[96] = {101, 224, 87, 85, 250, 119, 101, 245, 171, 170, 111, 112, 14, 255, 81, 15, 250, 162, 130, 40, 239, 97, 255, 240, 239, 181, 158, 205, 80, 239, 241, 6, 126, 245, 29, 95, 170, 47, 241, 243, 26, 166, 241, 22, 95, 13, 117, 95, 23, 191, 112, 251, 180, 87, 103, 233, 106, 146, 163, 95, 239, 191, 222, 101, 250, 162, 97, 250, 166, 16, 194, 34, 34, 32, 206, 206, 241, 12, 230, 66, 94, 163, 106, 95, 113, 8, 87, 117, 243, 51, 15, 243, 51, 255, 22, 87};
b8 d6_w[32] = {150, 26, 68, 16, 142, 93, 139, 52, 255, 83, 111, 31, 207, 124, 7, 107, 26, 174, 24, 186, 69, 39, 86, 203, 254, 58, 97, 151, 159, 56, 135, 105};
i8 d7_w[48] = {-64, 22, 0, 32, -14, -9, -7, -64, 38, -64, 38, -64, -64, -64, 8, -64, 64, 25, -15, 16, 64, 64, 32, 64, 64, 28, -49, 36, 64, 9, 64, 32, -64, -64, 64, -64, -64, 64, -64, 41, 64, 54, -64, -8, 64, -64, -64, 64};
b8 d8_w[96] = {111, 116, 165, 23, 76, 119, 254, 247, 5, 37, 165, 244, 209, 164, 165, 159, 65, 148, 214, 255, 96, 67, 76, 1, 159, 100, 42, 3, 87, 100, 219, 65, 42, 231, 167, 244, 77, 251, 187, 181, 179, 90, 61, 244, 239, 87, 169, 246, 47, 116, 187, 82, 212, 251, 196, 122, 187, 172, 90, 191, 159, 107, 246, 37, 161, 74, 107, 93, 245, 99, 115, 181, 99, 150, 187, 18, 172, 127, 191, 177, 116, 111, 118, 97, 73, 247, 66, 115, 220, 87, 79, 187, 118, 172, 84, 231};
b8 d11_w[32] = {253, 123, 57, 4, 162, 11, 150, 163, 37, 180, 155, 213, 85, 197, 205, 204, 229, 119, 185, 5, 168, 254, 135, 85, 84, 9, 128, 205, 47, 197, 81, 187};
i8 d12_w[48] = {5, 53, -37, -48, -38, -53, 25, 29, 64, -7, 64, 37, -8, 56, 64, -28, -54, -50, 14, -40, 64, 6, -64, 64, -18, -64, -45, 33, -47, 5, 15, -64, 64, 54, 3, 64, -41, 34, -33, 25, 64, -1, 63, 40, -34, -64, -64, -47};
b8 d13_w[96] = {71, 211, 42, 145, 193, 111, 223, 161, 111, 78, 22, 17, 192, 20, 127, 145, 204, 225, 169, 220, 129, 252, 235, 22, 70, 243, 42, 178, 171, 56, 177, 163, 250, 178, 164, 110, 200, 27, 42, 171, 112, 127, 178, 172, 129, 95, 33, 111, 178, 173, 14, 41, 204, 129, 202, 112, 20, 171, 116, 125, 219, 236, 129, 178, 170, 183, 31, 114, 156, 200, 29, 94, 178, 170, 30, 4, 235, 42, 178, 165, 227, 34, 235, 42, 192, 29, 183, 193, 225, 125, 178, 166, 129, 194, 29, 250};
b8 u1_w[64] = {151, 220, 131, 181, 61, 90, 4, 214, 1, 148, 0, 136, 16, 66, 129, 130, 44, 43, 67, 106, 230, 149, 241, 105, 43, 191, 20, 166, 254, 253, 12, 229, 69, 0, 92, 68, 128, 32, 155, 12, 105, 167, 116, 238, 182, 102, 223, 143, 104, 35, 255, 90, 226, 61, 251, 57, 0, 35, 0, 0, 40, 0, 0, 33};
i8 u2_w[64] = {25, 35, -64, -64, 12, 23, -10, -38, -64, -64, 64, 64, -51, 64, 64, -18, 59, -64, 64, 64, -64, -64, -30, -6, -28, -64, 64, -64, -64, -64, 18, 23, 64, 43, -64, -64, -23, -64, 64, -10, -64, -64, 64, 48, 11, 64, 64, -64, -64, 14, 15, 64, -15, 64, -64, 32, 64, -64, -64, 64, -64, 64, -64, -64};
b8 u3_w[64] = {56, 198, 130, 135, 122, 138, 106, 60, 154, 206, 2, 75, 154, 134, 134, 122, 122, 154, 156, 130, 76, 119, 152, 214, 156, 152, 120, 138, 35, 142, 216, 131, 33, 198, 131, 158, 138, 99, 35, 154, 54, 222, 135, 34, 142, 60, 142, 134, 130, 110, 206, 130, 67, 154, 120, 88, 218, 216, 2, 35, 98, 241, 175, 69};
b8 u6_w[64] = {225, 200, 227, 2, 80, 69, 18, 224, 42, 229, 81, 16, 74, 224, 244, 184, 168, 40, 28, 128, 9, 147, 20, 172, 143, 3, 186, 228, 8, 148, 243, 45, 25, 92, 22, 227, 165, 181, 150, 242, 89, 81, 63, 69, 247, 255, 37, 195, 64, 24, 100, 31, 54, 0, 12, 73, 188, 32, 56, 249, 112, 19, 166, 88};
i8 u7_w[32] = {-64, 4, -5, 8, -19, -7, -14, -64, -36, -2, -29, -18, 12, 1, -11, 27, 4, 1, -9, 11, -25, 64, -15, -1, 15, -64, 1, 5, -10, -3, -27, 5};


i32 down2_mem[28] = {0, 0, 0, 0, 0, 0, 0, 0};
i32 down3_mem[28] = {0, 0, 0, 0, 0, 0, 0, 0};
i32 down7_mem[12] = {-12, 20, -2, 8, -12, 20, -2, 8};
i32 down8_mem[12] = {-21, -2, -22, 23, -21, -2, -22, 23};
i32 down9_mem[192] = {-28, 18, 106, 16, -112, 106, -22, 60, 26, 18, 22, 112, -26, -26, 60, 66, -22, -68, 110, 12, 22, -18, -112, 16, 18, -54, 28, 24, 24, -72, 20, -22, -24, -18, 64, -22, 14, -100, -24, -104, -22, -66, -22, 22, 20, 64, 18, 70, 24, -62, -18, -26, -58, 106, -28, 16, 22, 16, 66, 60, -22, -24, -24, -30, -28, 18, 106, 16, -112, 106, -22, 60, 26, 18, 22, 112, -26, -26, 60, 66, -22, -68, 110, 12, 22, -18, -112, 16, 18, -54, 28, 24, 24, -72, 20, -22, -24, -18, 64, -22, 14, -100, -24, -104, -22, -66, -22, 22, 20, 64, 18, 70, 24, -62, -18, -26, -58, 106, -28, 16, 22, 16, 66, 60, -22, -24, -24, -30};
i32 down12_mem[12] = {19, 7, 17, -5, 19, 7, 17, -5};
i32 down13_mem[12] = {20, 5, -10, -17, 20, 5, -10, -17};
i32 down14_mem[320] = {-12, -48, 28, -42, 38, -42, 12, -72, 22, -32, 28, 52, 48, 62, 82, -52, 2, -48, -8, -22, -22, -32, -8, 36, 62, -8, -32, -42, -8, 62, -42, -42, -8, 52, 42, 62, 32, -18, -32, -12, 38, 62, -8, -32, -76, 42, 62, 28, -8, 22, 46, -8, -8, -42, -4, -8, 22, -36, 52, -56, -8, 2, 2, 38, -12, -48, 28, -42, 38, -42, 12, -72, 22, -32, 28, 52, 48, 62, 82, -52, 2, -48, -8, -22, -22, -32, -8, 36, 62, -8, -32, -42, -8, 62, -42, -42, -8, 52, 42, 62, 32, -18, -32, -12, 38, 62, -8, -32, -76, 42, 62, 28, -8, 22, 46, -8, -8, -42, -4, -8, 22, -36, 52, -56, -8, 2, 2, 38, -12, -48, 28, -42, 38, -42, 12, -72, 22, -32, 28, 52, 48, 62, 82, -52, 2, -48, -8, -22, -22, -32, -8, 36, 62, -8, -32, -42, -8, 62, -42, -42, -8, 52, 42, 62, 32, -18, -32, -12, 38, 62, -8, -32, -76, 42, 62, 28, -8, 22, 46, -8, -8, -42, -4, -8, 22, -36, 52, -56, -8, 2, 2, 38, -12, -48, 28, -42, 38, -42, 12, -72, 22, -32, 28, 52, 48, 62, 82, -52, 2, -48, -8, -22, -22, -32, -8, 36, 62, -8, -32, -42, -8, 62, -42, -42, -8,
                       52, 42, 62, 32, -18, -32, -12, 38, 62, -8, -32, -76, 42, 62, 28, -8, 22, 46, -8, -8, -42, -4, -8, 22, -36, 52, -56, -8, 2, 2, 38};
i32 up0_mem[128] = {0, 0, 1, 0, 1, 0, 0, 0, 1, 0, 1, 1, 1, 2, 2, 0, 0, 0, 0, 0, 0, 0, 0, 1, 2, 0, 0, 0, 0, 2, 0, 0, 0, 1, 1, 2, 1, 0, 0, 0, 1, 2, 0, 0, 0, 1, 2, 1, 0, 1, 1, 0, 0, 0, 0, 0, 1, 0, 1, 0, 0, 0, 0, 1};
i32 up5_mem[384] = {0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 24, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 10, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 0, 0, 2, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 2};


Pool1d d0 = (Pool1d) {12, 4, 4};
ConvI8 d1 = (ConvI8) {d1_w, 12, 4, 1, 1};
ConvI8 d2 = (ConvI8) {d2_w, 4, 4, 3, 1};
ConvB8 d3 = (ConvB8) {d3_w, 4, 64, 3, 1};
Pool1d d4 = (Pool1d) {64, 5, 5};
ConvB8 d6 = (ConvB8) {d6_w, 64, 4, 1, 1};
ConvI8 d7 = (ConvI8) {d7_w, 4, 4, 3, 1};
ConvB8 d8 = (ConvB8) {d8_w, 4, 64, 3, 1};
Pool1d d9 = (Pool1d) {64, 3, 1};
ConvB8 d11 = (ConvB8) {d11_w, 64, 4, 1, 1};
ConvI8 d12 = (ConvI8) {d12_w, 4, 4, 3, 1};
ConvB8 d13 = (ConvB8) {d13_w, 4, 64, 3, 1};
Pool1d d14 = (Pool1d) {64, 5, 1};

Upsample u0 = (Upsample) {64, 5};
ConvB8 u1 = (ConvB8) {u1_w, 64, 8, 1, 1};
ConvI8 u2 = (ConvI8) {u2_w, 8, 8, 1, 1};
ConvB8 u3 = (ConvB8) {u3_w, 8, 64, 1, 1};
Upsample u5 = (Upsample) {64, 4};
ConvB8 u6 = (ConvB8) {u6_w, 64, 8, 1, 1};
ConvI8 u7 = (ConvI8) {u7_w, 8, 4, 1, 1};

i32 down1_mem[5 * 12] = {0};
i32 down4_mem[5 * 64] = {0};
i32 down5_mem[1 * 64] = {0};
i32 down6_mem[1 * 64] = {0};
i32 down10_mem[1 * 64] = {0};
i32 down11_mem[1 * 64] = {0};
i32 down15_mem[1 * 64] = {0};

Buffer dbf1 = (Buffer) {down1_mem, 5, 12, 0}; // QConv1d(12, 4, 1, 1, q
Buffer dbf2 = (Buffer) {down2_mem, 7, 4, 2};  // QConv1d(4, 4, 3, 1, b_
Buffer dbf3 = (Buffer) {down3_mem, 7, 4, 2};   // QConv1d(4, 64, 3, 1,)
Buffer dbf4 = (Buffer) {down4_mem, 5, 64, 0}; // AvgPool1d(5, stride=5),
Buffer dbf5 = (Buffer) {down5_mem, 1, 64, 0}; // softmax(dim=1),
Buffer dbf6 = (Buffer) {down6_mem, 1, 64, 0}; // QConv1d(64, 4, 1, 1,)
Buffer dbf7 = (Buffer) {down7_mem, 3, 4, 2}; // QConv1d(4, 4, 3, 1,)
Buffer dbf8 = (Buffer) {down8_mem, 3, 4, 2}; // QConv1d(4, 64, 3, 1, ),
Buffer dbf9 = (Buffer) {down9_mem, 3, 64, 2}; //AvgPool1d(3, stride=1),
Buffer dbf10 = (Buffer) {down10_mem, 1, 64, 0}; //softmax(dim=1),
Buffer dbf11 = (Buffer) {down11_mem, 1, 64, 0}; //QConv1d(64, 4, 1, ),
Buffer dbf12 = (Buffer) {down12_mem, 3, 4, 2}; //QConv1d(4, 4, 3, b_weight=False),
Buffer dbf13 = (Buffer) {down13_mem, 3, 4, 2}; //QConv1d(4, 64, 3),
Buffer dbf14 = (Buffer) {down14_mem, 5, 64, 4}; // AvgPool1d(5, stride=1),
Buffer dbf15 = (Buffer) {down15_mem, 1, 64, 0}; // softmax(dim=1),

i32 up1_mem[5 * 64] = {0};
i32 up2_mem[5 * 8] = {0};
i32 up3_mem[5 * 8] = {0};
i32 up4_mem[5 * 64] = {0};
i32 up6_mem[20 * 64] = {0};
i32 up7_mem[20 * 8] = {0};
i32 up8_mem[20 * 4] = {0};
Buffer ubf0 = (Buffer) {up0_mem, 2, 64, 1};    // Upsample(5),
Buffer ubf1 = (Buffer) {up1_mem, 5, 64, 0};  // QConv1d(64, 8, 1),
Buffer ubf2 = (Buffer) {up2_mem, 5, 8, 0};  // QConv1d(8, 8, 1, b_weight=False),
Buffer ubf3 = (Buffer) {up3_mem, 5, 8, 0};  // QConv1d(8, 64, 1),
Buffer ubf4 = (Buffer) {up4_mem, 5, 64, 0};  // softmax(dim=1),,
Buffer ubf5 = (Buffer) {up5_mem, 6, 64, 1};  // Upsample(4),
Buffer ubf6 = (Buffer) {up6_mem, 20, 64, 0};  // QConv1d(64, 8, 1),
Buffer ubf7 = (Buffer) {up7_mem, 20, 8, 0};  // QConv1d(8, 4, 1, b_weight=False),
Buffer ubf8 = (Buffer) {up8_mem, 20, 4, 0};  // y

MatI32 Bf2I32(Buffer dbf) {
    return (MatI32) {dbf.data, dbf.length, dbf.channels};
}

Buffer down(Buffer dbf0) {
    avg_pool1d_i32(dbf0, d0, dbf1);      // nn.AvgPool1d(4, stride=4)
    conv1d_i32_i8(dbf1, d1, dbf2);       // QConv1d(12, 4, 1, 1, q_input_bias=False, b_weight=False),
    conv1d_i32_i8(dbf2, d2, dbf3);       // QConv1d(4, 4, 3, 1, b_weight=False),
    conv1d_i32_b8(dbf3, d3, dbf4);       // QConv1d(4, 64, 3, 1,)
    avg_pool1d_i32(dbf4, d4, dbf5);      // QConv1d(4, 64, 3, 1,)
    softmax(dbf5, dbf6);
    conv1d_i32_b8(dbf6, d6, dbf7);       // QConv1d(64, 4, 1, 1,)
    conv1d_i32_i8(dbf7, d7, dbf8);       // QConv1d(4, 4, 3, 1,)
    conv1d_i32_b8(dbf8, d8, dbf9);
    avg_pool1d_i32(dbf9, d9, dbf10);
    softmax(dbf10, dbf11);
    conv1d_i32_b8(dbf11, d11, dbf12);   // QConv1d(64, 4, 1, 1,)
    conv1d_i32_i8(dbf12, d12, dbf13);   // QC1onv1d(4, 4, 3, 1,)
    conv1d_i32_b8(dbf13, d13, dbf14);
    avg_pool1d_i32(dbf14, d14, dbf15);
    softmax(dbf15, ubf0);
    return ubf0;
}

Buffer up(Buffer x) {
    upsample_linear(x, u0, ubf1);
    conv1d_i32_b8(ubf1, u1, ubf2);   // QConv1d(64, 4, 1, 1,)
    conv1d_i32_i8(ubf2, u2, ubf3);   // QConv1d(4, 4, 3, 1,)
    conv1d_i32_b8(ubf3, u3, ubf4);
    softmax(ubf4, ubf5);
    upsample_linear(ubf5, u5, ubf6);
    conv1d_i32_b8(ubf6, u6, ubf7);   // QConv1d(64, 4, 1, 1,)
    conv1d_i32_i8(ubf7, u7, ubf8);   // QConv1d(4, 4, 3, 1,)
    return ubf8;
}


void sw_seg_20_12_500_100(f32 *in_data, i8 *out_data) {
    // in_data 是 20*12 的数组，12为导联数(优先存储)，20为采样数，采样频率为500hz，
    //          去工频干扰和基线漂移后的数据，标准化后的数据 (均值为0，方差为1)，
    //          I,II,III,aVL,aVR,aVF,V1,V2,V3,V4,V5,V6
    // out_data 是20的数组，20为采样数（延迟 100 次采样），
    //          数值输出为 0(背景波), 1(p波), 2(t波), 3(qrs波)

    // 接收输入参数
    i32 x_data[20 * 12];
    f32_2_i32(in_data, x_data, 20 * 12);
    for (int i = 0; i < 20*12; ++i) x_data[i] /= 8;       // 除以8

    // 运行模型
    Buffer bf = up(down((Buffer){x_data, 20, 12, 0}));

    // 导出到输出参数
    for (int i = 0; i < 20; ++i) {
        int max_j = 0;
        for (int j = 1; j < 4; ++j) {
            if(bf.data[i*4+ j] > bf.data[i*4+ max_j]){
                max_j = j;
            }
        }
        bf.data[i] = max_j;
    }
}

int main() {

    f32 data[1500 * 12] = {0};
    for (int i = 0; i < 12 * 20; ++i) {
        data[i] = (f32) 1;
    }

    int length = 20;
    int channels = 12;

    MatI32 x = F32_2_I32(F32(data, length, channels));

    for (int i = 0; i < x.length * x.channels; ++i) x.data[i] /= 8;       // 除以8

    Buffer dbf0 = (Buffer) {x.data, 20, 12, 0};
    Buffer dbf_down = down(dbf0);

    Buffer dbf_up = up(dbf_down);

    x = Bf2I32(dbf_up);
    printMI32("mem", x);
    MatF32 mf = I32_2_F32(x);

    printMF32("output", mf);
    FILE *file = fopen("../data.bin", "wb");
    fwrite(mf.data, sizeof(f32), mf.length * mf.channels, file);
    fclose(file);
    return 1;
}
