#include "../h_sw/layer.h"

//i8 cd1_w[48] = {64, 64, 64, -64, -64, 64, -64, -64, -64, -64, -64, -15, 64, 64, 64, -64, -64, 64, -64, 64, 64, 64, 64, 64, 64, 64, -64, -64, 64, -64, 64, 45, 4, 14, 42, 5, 64, 64, 64, 42, 64, -64, -64, -64, -54, 16, 64, 64};
//i8 cd2_w[48] = {-64, -64, 36, -64, 11, -8, 64, -64, 64, -61, 64, -45, 64, 64, 9, -64, 23, 64, -64, -64, 40, -12, 32, -64, 64, 64, 64, 64, 64, -43, 64, 64, 64, 17, 64, 64, 1, -64, -64, 36, 64, -64, -64, -64, 20, -64, -64, -64};
//b8 cd3_w[96] = {0, 180, 85, 238, 237, 220, 142, 100, 93, 103, 180, 98, 197, 91, 50, 164, 83, 93, 206, 137, 166, 103, 25, 238, 28, 238, 197, 232, 93, 6, 221, 208, 1, 155, 46, 228, 215, 232, 229, 1, 110, 229, 205, 241, 24, 206, 108, 223, 87, 125, 221, 17, 77, 221, 238, 243, 20, 208, 14, 228, 129, 187, 129, 103, 211, 170, 137, 25, 157, 215, 125, 196, 155, 55, 85, 197, 244, 87, 197, 83, 153, 87, 124, 201, 168, 189, 221, 238, 67, 48, 206, 214, 115, 68, 81, 20};
//b8 cd6_w[32] = {196, 232, 102, 249, 146, 218, 187, 138, 171, 99, 53, 244, 175, 82, 130, 180, 32, 43, 225, 219, 9, 130, 50, 56, 50, 87, 10, 128, 208, 182, 198, 196};
//i8 cd7_w[48] = {3, 16, -64, 56, -34, 27, -12, 5, 10, -35, 64, -64, -64, -21, 38, 57, 64, -15, -18, -1, 64, 43, -4, -64, 64, -64, -24, 43, -64, -28, 24, 22, -23, 64, 7, -64, -64, -64, -63, -36, -10, 37, 64, 11, 28, 64, 1, 10};
//b8 cd8_w[96] = {198, 103, 119, 252, 209, 87, 206, 183, 17, 194, 248, 136, 25, 143, 84, 98, 111, 112, 238, 195, 149, 20, 87, 48, 247, 205, 131, 17, 169, 147, 41, 213, 12, 20, 91, 149, 14, 253, 198, 194, 7, 19, 131, 32, 32, 238, 79, 245, 202, 176, 119, 85, 64, 64, 201, 71, 92, 194, 188, 235, 191, 103, 119, 147, 48, 239, 137, 220, 149, 14, 255, 80, 216, 60, 251, 141, 58, 228, 156, 224, 69, 252, 50, 187, 2, 237, 223, 146, 58, 157, 13, 30, 237, 162, 176, 65};
//b8 cd11_w[32] = {85, 123, 166, 167, 116, 243, 20, 133, 154, 94, 7, 141, 255, 151, 229, 171, 215, 163, 114, 126, 120, 109, 190, 41, 77, 223, 183, 147, 101, 91, 80, 4};
//i8 cd12_w[48] = {-64, -64, 11, -34, -27, -29, 31, 20, 10, 64, 25, 48, -35, 64, 49, -64, 0, 64, 21, -54, 64, -64, 64, -21, 64, 64, -1, 17, -17, -30, -14, 17, -64, -64, 42, -3, -13, -4, 25, 64, 3, 23, -3, 38, 58, -52, 41, -39};
//b8 cd13_w[96] = {1, 28, 128, 64, 147, 0, 187, 218, 237, 189, 220, 168, 94, 170, 167, 0, 89, 196, 186, 228, 137, 83, 183, 102, 185, 85, 107, 176, 78, 216, 99, 190, 193, 32, 132, 202, 213, 1, 255, 174, 236, 136, 64, 62, 221, 76, 138, 118, 140, 137, 127, 153, 83, 44, 202, 143, 238, 142, 36, 122, 172, 90, 212, 184, 83, 68, 168, 203, 213, 129, 92, 55, 86, 180, 137, 181, 78, 230, 60, 205, 93, 65, 94, 232, 102, 163, 51, 185, 86, 106, 48, 105, 19, 136, 169, 4};
//b8 cu1_w[64] = {31, 56, 144, 135, 48, 252, 44, 33, 254, 249, 245, 231, 251, 255, 47, 15, 35, 5, 118, 20, 137, 252, 195, 178, 255, 118, 239, 204, 112, 247, 138, 109, 202, 232, 65, 235, 119, 39, 22, 4, 16, 0, 10, 20, 16, 16, 0, 192, 207, 112, 180, 179, 162, 252, 59, 43, 158, 56, 177, 126, 54, 237, 108, 109};
//i8 cu2_w[64] = {18, -47, -48, -16, -13, 17, -6, 64, -64, -34, 64, -64, -64, 8, -40, -64, -12, 16, 18, 64, -26, -44, -64, 64, 31, -64, 64, -64, -64, 64, -22, -64, -46, -64, -19, 64, -26, 64, -64, -35, 64, 42, 52, -23, -64, 64, 64, -9, -1, 29, -64, 7, 64, -14, 49, 64, 2, 27, 59, 14, -64, 10, 49, -10};
//b8 cu3_w[64] = {64, 63, 166, 0, 159, 129, 239, 99, 167, 170, 29, 9, 192, 63, 120, 63, 75, 208, 128, 190, 191, 85, 161, 225, 16, 193, 158, 101, 192, 219, 63, 34, 179, 204, 194, 85, 191, 76, 47, 130, 159, 73, 129, 137, 209, 192, 31, 64, 58, 33, 129, 148, 59, 131, 80, 189, 175, 193, 137, 129, 175, 61, 75, 31};
//b8 cu5_w[64] = {127, 246, 170, 239, 138, 179, 249, 248, 168, 194, 20, 34, 81, 132, 0, 181, 72, 135, 24, 34, 11, 146, 29, 141, 126, 255, 239, 254, 207, 255, 253, 255, 127, 255, 239, 94, 255, 253, 93, 255, 191, 255, 255, 255, 223, 255, 255, 255, 104, 157, 235, 76, 223, 126, 125, 118, 16, 107, 16, 248, 49, 0, 160, 132};
//i8 cu7_w[16] = {-64, -32, -64, 0, 10, 30, 14, 1, 64, 2, 62, 7, -1, 64, 7, 8};

i8 cd1_w[48] = {64, 64, 64, -64, -64, 64, -64, -64, -64, -64, -64, -15, 64, 64, 64, -64, -64, 64, -64, 64, 64, 64, 64, 64, 64, 64, -64, -64, 64, -64, 64, 46, 4, 15, 43, 5, 64, 64, 64, 41, 64, -64, -64, -64, -55, 16, 64, 64};
i8 cd2_w[48] = {-64, -64, 37, -64, 11, -8, 64, -64, 64, -61, 64, -46, 64, 64, 10, -64, 21, 64, -64, -64, 39, -10, 33, -64, 64, 64, 64, 64, 64, -42, 64, 64, 64, 17, 64, 64, 1, -64, -64, 35, 64, -64, -64, -64, 21, -64, -64, -64};
b8 cd3_w[96] = {0, 180, 85, 238, 109, 220, 142, 101, 93, 103, 180, 98, 197, 91, 50, 228, 83, 93, 206, 153, 166, 99, 25, 238, 28, 238, 197, 232, 93, 6, 221, 208, 1, 155, 46, 228, 87, 238, 100, 1, 110, 229, 205, 241, 24, 206, 108, 223, 87, 125, 221, 17, 77, 221, 238, 243, 20, 112, 14, 228, 129, 187, 129, 119, 211, 170, 133, 25, 157, 215, 125, 196, 155, 55, 85, 196, 252, 87, 197, 83, 153, 87, 124, 201, 170, 189, 221, 238, 67, 52, 198, 214, 115, 68, 81, 20};
b8 cd6_w[32] = {196, 232, 102, 249, 154, 218, 187, 138, 171, 115, 53, 244, 175, 82, 130, 180, 32, 43, 225, 219, 9, 130, 34, 58, 54, 87, 10, 128, 208, 246, 198, 196};
i8 cd7_w[48] = {2, 16, -64, 57, -36, 28, -12, 6, 9, -34, 64, -64, -64, -21, 38, 56, 64, -15, -18, -2, 64, 43, -4, -64, 64, -64, -24, 42, -64, -28, 23, 21, -24, 64, 6, -64, -64, -64, -63, -36, -11, 38, 64, 11, 26, 64, 1, 10};
b8 cd8_w[96] = {194, 103, 119, 252, 209, 87, 206, 183, 17, 195, 184, 136, 25, 143, 84, 102, 79, 112, 238, 203, 149, 20, 87, 48, 247, 204, 195, 17, 161, 179, 41, 213, 12, 84, 91, 149, 14, 252, 199, 196, 7, 19, 131, 32, 32, 238, 79, 245, 203, 176, 119, 85, 64, 64, 201, 87, 92, 194, 188, 235, 191, 103, 119, 145, 48, 239, 153, 212, 197, 14, 255, 80, 216, 60, 251, 141, 58, 228, 156, 96, 69, 204, 50, 187, 2, 237, 207, 146, 58, 157, 76, 30, 237, 34, 176, 69};
b8 cd11_w[32] = {85, 123, 166, 167, 116, 243, 20, 133, 152, 94, 7, 45, 255, 159, 197, 171, 213, 162, 114, 126, 120, 109, 190, 41, 77, 223, 183, 147, 101, 91, 80, 4};
i8 cd12_w[48] = {-64, -64, 9, -36, -29, -30, 30, 19, 10, 64, 24, 47, -35, 64, 51, -64, 0, 64, 22, -58, 64, -64, 64, -26, 64, 64, 0, 18, -17, -30, -13, 16, -64, -64, 43, -5, -13, -6, 24, 64, 3, 21, -4, 38, 59, -53, 40, -38};
b8 cd13_w[96] = {5, 92, 192, 128, 147, 0, 187, 218, 237, 189, 220, 168, 94, 170, 231, 32, 89, 196, 190, 224, 137, 83, 183, 102, 185, 21, 107, 48, 78, 200, 99, 190, 160, 32, 132, 202, 213, 1, 255, 46, 232, 136, 64, 62, 221, 76, 138, 118, 136, 137, 127, 153, 83, 44, 202, 143, 238, 254, 38, 106, 172, 90, 212, 186, 87, 68, 168, 203, 213, 129, 92, 55, 86, 180, 137, 181, 78, 102, 60, 205, 93, 65, 94, 232, 102, 163, 51, 185, 86, 106, 48, 41, 3, 136, 169, 4};
b8 cu1_w[64] = {31, 56, 144, 151, 56, 252, 44, 35, 254, 253, 245, 231, 251, 255, 111, 15, 163, 5, 118, 20, 139, 252, 195, 178, 251, 118, 238, 204, 112, 119, 142, 109, 200, 232, 65, 235, 119, 39, 150, 4, 16, 0, 10, 20, 24, 16, 0, 192, 207, 112, 180, 187, 162, 252, 59, 43, 158, 56, 177, 126, 54, 237, 108, 109};
i8 cu2_w[64] = {22, -47, -54, -13, -14, 17, -5, 64, -64, -34, 64, -64, -64, 8, -37, -64, -5, 16, 10, 64, -20, -42, -64, 64, 26, -64, 64, -64, -64, 64, -24, -64, -43, -64, -27, 64, -23, 64, -64, -29, 64, 43, 50, -21, -64, 64, 64, -6, 2, 29, -64, 10, 64, -13, 49, 64, 3, 29, 52, 19, -64, 8, 49, -4};
b8 cu3_w[64] = {64, 63, 166, 0, 191, 129, 237, 99, 167, 170, 61, 9, 192, 63, 120, 63, 75, 208, 0, 190, 175, 85, 33, 225, 2, 129, 158, 101, 128, 158, 63, 34, 179, 204, 194, 85, 175, 68, 47, 130, 175, 73, 129, 137, 85, 208, 31, 0, 58, 33, 129, 144, 59, 131, 80, 175, 175, 207, 129, 129, 171, 61, 65, 63};
b8 cu5_w[64] = {127, 246, 170, 239, 138, 179, 249, 249, 40, 194, 20, 34, 65, 134, 0, 181, 72, 135, 24, 34, 11, 146, 29, 141, 126, 255, 239, 254, 207, 255, 253, 255, 127, 255, 239, 94, 255, 253, 93, 255, 191, 255, 255, 255, 223, 255, 253, 255, 104, 157, 235, 76, 223, 126, 125, 118, 16, 107, 16, 248, 33, 0, 160, 132};
i8 cu7_w[16] = {-64, -34, -64, -2, 11, 32, 17, 0, 64, 4, 64, 9, -2, 64, 0, 10};


//Pool1d d0 = (Pool1d) {12, 4, 4};
ConvI8 d1 = {cd1_w, 12, 4, 1, 1};
ConvI8 d2 = {cd2_w, 4, 4, 3, 1};
ConvB8 d3 = {cd3_w, 4, 64, 3, 1};
Pool1d d4 = {64, 5, 5};
ConvB8 d6 = {cd6_w, 64, 4, 1, 1};
ConvI8 d7 = {cd7_w, 4, 4, 3, 1};
ConvB8 d8 = {cd8_w, 4, 64, 3, 1};
Pool1d d9 = {64, 3, 1};
ConvB8 d11 = {cd11_w, 64, 4, 1, 1};
ConvI8 d12 = {cd12_w, 4, 4, 3, 1};
ConvB8 d13 = {cd13_w, 4, 64, 3, 1};
Pool1d d14 = {64, 5, 1};

ConvB8 u1 = {cu1_w, 64, 8, 1, 1};
ConvI8 u2 = {cu2_w, 8, 8, 1, 1};
ConvB8 u3 = {cu3_w, 8, 64, 1, 1};
ConvB8 u6 = {cu5_w, 64, 8, 1, 1};
ConvI8 u7 = {cu7_w, 8, 4, 1, 1};

i32 down1_mem[5 * 12] = {0};
i32 down2_mem[7 * 4] = {0};
i32 down3_mem[7 * 4] = {0};
i32 down4_mem[5 * 64] = {0};
i32 down5_mem[1 * 64] = {0};
i32 down6_mem[1 * 64] = {0};
i32 down7_mem[3 * 4] = {0};
i32 down8_mem[3 * 4] = {0};
i32 down9_mem[3 * 64] = {0};
i32 down10_mem[1 * 64] = {0};
i32 down11_mem[1 * 64] = {0};
i32 down12_mem[3 * 4] = {0};
i32 down13_mem[3 * 4] = {0};
i32 down14_mem[5 * 64] = {0};
i32 down15_mem[1 * 64] = {0};

i32 up1_mem[5 * 64] = {0};
i32 up2_mem[5 * 8] = {0};
i32 up3_mem[5 * 8] = {0};
i32 up4_mem[5 * 64] = {0};
i32 up5_mem[5 * 64] = {0};
i32 up6_mem[5 * 8] = {0};
i32 up7_mem[5 * 2] = {0};

Buffer dbf1 = {down1_mem, 5, 12, 0}; // QConv1d(12, 4, 1, 1, q
Buffer dbf2 = {down2_mem, 7, 4, 2};  // QConv1d(4, 4, 3, 1, b_
Buffer dbf3 = {down3_mem, 7, 4, 2};   // QConv1d(4, 64, 3, 1,)
Buffer dbf4 = {down4_mem, 5, 64, 0}; // AvgPool1d(5, stride=5),
Buffer dbf5 = {down5_mem, 1, 64, 0}; // softmax(dim=1),
Buffer dbf6 = {down6_mem, 1, 64, 0}; // QConv1d(64, 4, 1, 1,)
Buffer dbf7 = {down7_mem, 3, 4, 2}; // QConv1d(4, 4, 3, 1,)
Buffer dbf8 = {down8_mem, 3, 4, 2}; // QConv1d(4, 64, 3, 1, ),
Buffer dbf9 = {down9_mem, 3, 64, 2}; //AvgPool1d(3, stride=1),
Buffer dbf10 = {down10_mem, 1, 64, 0}; //softmax(dim=1),
Buffer dbf11 = {down11_mem, 1, 64, 0}; //QConv1d(64, 4, 1, ),
Buffer dbf12 = {down12_mem, 3, 4, 2}; //QConv1d(4, 4, 3, b_weight=False),
Buffer dbf13 = {down13_mem, 3, 4, 2}; //QConv1d(4, 64, 3),
Buffer dbf14 = {down14_mem, 5, 64, 4}; // AvgPool1d(5, stride=1),
Buffer dbf15 = {down15_mem, 1, 64, 0}; // softmax(dim=1),

//Buffer ubf0 = (Buffer) {up0_mem, 2, 64, 1};    // Upsample(5),
Buffer ubf1 = {up1_mem, 1, 64, 0}; // QConv1d(64, 8, 1),
Buffer ubf2 = {up2_mem, 1, 8, 0};  // QConv1d(8, 8, 1, b_weight=False),
Buffer ubf3 = {up3_mem, 1, 8, 0};  // QConv1d(8, 64, 1),
Buffer ubf4 = {up4_mem, 1, 64, 0}; // softmax(dim=1),,
//Buffer ubf5 = (Buffer) {up5_mem, 6, 64, 1};  // Upsample(4),
Buffer ubf5 = {up5_mem, 1, 64, 0}; // QConv1d(64, 8, 1),
Buffer ubf6 = {up6_mem, 1, 8, 0};  // QConv1d(8, 4, 1, b_weight=False),
Buffer ubf7 = {up7_mem, 1, 2, 0};  // y

MatI32 Bf2I32(Buffer dbf) {
    return (MatI32) {dbf.data, dbf.length, dbf.channels};
}

Buffer down(Buffer dbf0) {
//    avg_pool1d_i32(dbf0, d0, dbf1);      // nn.AvgPool1d(4, stride=4)
    conv1d_i32_i8(dbf0, d1, dbf2);       // QConv1d(12, 4, 1, 1, q_input_bias=False, b_weight=False),
//    f32 d[12*4];
//    i8_2_f32(d1.weight, d, 12*4);
//    printMF32("d1", F32(d, 12, 4));
//    printMI32("dbf2", I32(dbf2.data, dbf2.length, dbf2.channels));
    conv1d_i32_i8(dbf2, d2, dbf3);       // QConv1d(4, 4, 3, 1, b_weight=False)
    conv1d_i32_b8(dbf3, d3, dbf4);       // QConv1d(4, 64, 3, 1,)
    avg_pool1d_i32(dbf4, d4, dbf5);      // QConv1d(4, 64, 3, 1,),
    softmax(dbf5, dbf6);
//    printMI32("dbf6", I32(dbf6.data, dbf6.length, dbf6.channels));
    conv1d_i32_b8(dbf6, d6, dbf7);       // QConv1d(64, 4, 1, 1,)
//    printMI32("dbf7", I32(dbf7.data, dbf7.length, dbf7.channels));
    conv1d_i32_i8(dbf7, d7, dbf8);       // QConv1d(4, 4, 3, 1,)
    conv1d_i32_b8(dbf8, d8, dbf9);
    avg_pool1d_i32(dbf9, d9, dbf10);
    softmax(dbf10, dbf11);
    conv1d_i32_b8(dbf11, d11, dbf12);   // QConv1d(64, 4, 1, 1,)
    conv1d_i32_i8(dbf12, d12, dbf13);   // QC1onv1d(4, 4, 3, 1,)
    conv1d_i32_b8(dbf13, d13, dbf14);
    avg_pool1d_i32(dbf14, d14, dbf15);
    softmax(dbf15, ubf1);
    return ubf1;
}

Buffer up(Buffer x) {
//    upsample_linear(x, u0, ubf1);
    conv1d_i32_b8(x, u1, ubf2);   // QConv1d(64, 4, 1, 1,)
    conv1d_i32_i8(ubf2, u2, ubf3);   // QConv1d(4, 4, 3, 1,)
    conv1d_i32_b8(ubf3, u3, ubf4);
    softmax(ubf4, ubf5);
//    upsample_linear(ubf5, u5, ubf6);
    conv1d_i32_b8(ubf5, u6, ubf6);   // QConv1d(64, 4, 1, 1,)
    conv1d_i32_i8(ubf6, u7, ubf7);   // QConv1d(4, 2, 1, 1,)
    return ubf7;
}


i32 sw_cls_5_12_125_100(f32 *in_data) {
    // in_data 是 5*12 的数组，12为导联数(优先存储)，20为采样数，采样频率为 125 hz，
    //          去工频干扰和基线漂移后的数据，标准化后的数据 (均值为0，方差为1)，
    //          I,II,III,aVL,aVR,aVF,V1,V2,V3,V4,V5,V6
    // out_data 是长度为1的数组，0 延迟
    //          数值输出为 0(背景波), 1(p波), 2(t波), 3(qrs波)
    // 接收输入参数
    i32 x_data[5 * 12];
    f32_2_i32(in_data, x_data, 5 * 12);
    for (int i = 0; i < 5 * 12; ++i) x_data[i] /= 8;       // 除以8

    // 运行模型
    Buffer bf = up(down((Buffer) {x_data, 5, 12, 0}));
    printMI32("res", I32(bf.data, 1, 2));
    // 导出到输出参数
    if (bf.data[0] > bf.data[1]) {
        return 0;
    } else {
        return 1;
    }
}

int main() {

    f32 data[5 * 12] = {0};
    for (int i = 0; i < 12 * 5; ++i) { data[i] = (f32) i; }

    for (int i = 0; i < 20; ++i) {
        i32 odata = sw_cls_5_12_125_100(data);
//        printf("%d res: %d\n", i, odata);
    }
    return 1;
}
