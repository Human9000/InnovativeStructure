#include "../h/layer.h"

#include "math.h"

typedef struct {
    double re;
    double im;
} Complex;

Complex Csqrt(Complex a) {
    double r = sqrt(a.im * a.im + a.re * a.re);
    double re = sqrt(r * (1 + a.im/r) / 2);
    double im = sqrt(r * (1 + a.re/r) / 2);
    return (Complex){re, im};
}

//i8 d1_w[48] = {49,56,19,50,-23,-1,8,64,64,64,9,-10,64,64,13,-64,64,64,-64,64,64,64,64,64,64,64,-64,-64,64,64,-64,-64,-52,64,64,64,-64,-64,64,64,-64,-64,64,18,-64,-64,-64,-64};
//i8 d2_w[48] = {-64,-64,64,64,-64,-64,-64,64,64,-64,-64,64,-37,-64,-5,7,-15,11,16,64,64,64,-64,0,-64,64,64,-64,30,-58,7,-4,-64,-64,-64,64,64,-64,-64,64,-64,-27,-3,18,64,64,64,-64};
//b8 d3_w[96] = {174,86,114,4,18,204,254,172,200,165,129,42,44,141,206,140,133,17,81,26,72,103,96,68,109,171,72,109,103,105,46,65,42,209,22,222,70,237,206,172,136,136,173,141,250,4,18,217,17,160,214,205,90,237,42,226,174,77,100,214,197,229,17,101,110,90,79,128,69,221,30,213,109,34,88,220,92,206,68,237,220,44,196,214,228,143,213,45,142,237,46,71,214,236,214,218};
//b8 d6_w[32] = {33,25,6,130,188,64,8,64,246,166,249,191,195,28,219,45,144,152,191,173,255,75,175,94,155,164,204,125,156,19,66,251};
//i8 d7_w[48] = {-64,14,-23,64,-44,-5,-64,-64,-64,64,-64,-64,32,64,-5,37,-23,-8,6,3,64,-64,64,64,-42,10,-64,-40,-64,33,-22,-36,64,-64,-2,4,64,23,64,64,-64,-11,47,21,64,-47,-14,-64};
//b8 d8_w[96] = {24,237,250,134,153,63,123,136,151,230,31,128,110,159,73,32,133,184,183,239,176,100,156,134,131,101,250,135,102,238,100,20,236,63,184,135,46,155,160,163,191,224,97,152,199,68,225,138,89,135,250,160,130,41,115,130,251,133,112,40,122,247,184,41,108,201,161,103,237,78,200,127,127,254,65,78,194,169,32,134,9,101,155,109,228,145,230,127,175,128,25,234,135,160,131,40};
//b8 d11_w[32] = {22,73,169,37,2,169,66,76,3,247,233,92,249,72,79,151,194,90,72,25,128,135,199,232,178,238,8,233,61,144,95,131};
//i8 d12_w[48] = {-64,25,-39,-19,58,64,-9,-39,21,-64,52,64,36,-59,-35,-20,64,22,-20,-64,-64,64,64,64,-64,-40,-64,-17,64,15,-38,-64,-64,-46,64,64,50,11,64,-3,-7,64,28,-31,-64,-64,-42,64};
//b8 d13_w[96] = {65,161,23,225,5,71,93,189,243,216,154,239,121,177,87,12,216,219,212,149,103,201,113,85,84,152,159,91,158,112,227,5,85,0,174,207,152,249,151,24,216,207,70,243,8,95,184,59,207,153,151,80,60,155,171,191,151,236,199,155,133,226,48,25,113,74,173,177,248,217,184,207,119,113,35,196,222,32,140,246,48,160,9,151,95,177,85,144,17,55,207,154,207,123,154,207};
//b8 u1_w[64] = {73,40,1,185,2,1,40,69,232,137,186,36,2,110,54,10,117,111,229,248,102,165,185,84,236,103,4,192,100,32,195,80,255,251,231,255,255,251,248,255,175,184,251,231,187,222,62,143,32,40,57,156,64,65,190,37,238,18,58,7,144,220,31,206};
//i8 u2_w[64] = {64,-64,32,-64,64,64,-64,-64,6,-28,8,-44,17,33,-42,-38,-23,-8,10,23,30,6,64,64,60,-13,16,9,9,-32,-64,-64,-59,-64,64,64,64,-64,-17,-33,64,64,64,-50,-24,64,64,-56,64,-26,64,64,-40,-64,57,-64,64,46,-64,-15,-6,4,-64,-64};
//b8 u3_w[64] = {177,147,6,188,250,211,6,210,164,36,198,214,242,6,247,115,95,161,6,51,211,152,178,251,93,190,177,243,211,154,6,242,240,159,210,95,210,241,115,27,0,174,233,11,32,211,51,38,243,76,243,192,45,6,167,242,242,179,34,68,18,38,251,212};
//b8 u6_w[64] = {250,62,135,78,75,96,181,197,27,13,181,76,149,243,219,194,152,216,68,238,197,174,254,117,1,47,136,203,189,145,65,162,3,57,176,0,134,49,145,192,247,247,235,203,122,206,111,55,99,8,184,221,43,134,37,178,76,94,41,134,97,218,69,182};
//i8 u7_w[32] = {-12,64,64,16,-5,64,1,-64,-26,32,20,-64,39,64,28,15,7,64,-22,-1,-64,4,-21,-1,64,-4,41,64,6,64,-17,-1};



i8 d1_w[48] = {64, 11, -64, -50, -64, 64, 64, 64, 64, 64, 64, 64, 64, 64, -42, -64, 64, 40, -64, -64, 5, 64, 64, 64,
               -64, -64, 52, 64, -64, -35, 64, -13, -57, -64, -64, -62, -34, -64, 2, -64, 30, -64, 64, -64, -64, -52,
               15, 39};
i8 d2_w[48] = {-5, 64, -25, 28, -31, -64, 64, 33, 11, -64, 64, -9, -22, 64, -32, 42, -64, -64, 64, 64, -64, -64, 64, 33,
               -29, -3, 2, 16, -6, -31, 14, -21, 36, -57, 50, -27, -64, -64, 64, -64, 58, -64, 64, 14, 64, -64, -23,
               -55};
b8 d3_w[96] = {166, 165, 95, 85, 186, 34, 35, 247, 94, 98, 111, 240, 15, 255, 17, 11, 250, 162, 34, 32, 239, 135, 127,
               240, 239, 183, 95, 85, 112, 239, 241, 5, 95, 247, 21, 87, 171, 111, 241, 243, 26, 162, 81, 89, 91, 149,
               117, 23, 187, 191, 241, 187, 181, 31, 114, 245, 87, 117, 243, 87, 255, 183, 95, 85, 122, 162, 148, 112,
               34, 16, 66, 50, 184, 176, 206, 142, 241, 4, 244, 197, 87, 226, 107, 139, 208, 1, 119, 81, 211, 51, 15,
               243, 51, 255, 4, 23};
b8 d6_w[32] = {22, 24, 64, 148, 40, 93, 139, 20, 255, 215, 119, 159, 223, 124, 135, 107, 27, 174, 24, 184, 25, 15, 112,
               238, 250, 58, 5, 150, 31, 56, 135, 105};
i8 d7_w[48] = {-56, -26, 24, 5, -3, -26, 25, -58, -15, -62, 41, -64, -6, -21, -4, -39, 64, 33, 25, -1, 58, 64, 35, 64,
               46, 12, 7, 26, 14, 20, 18, -3, -27, -64, 48, -14, 14, 36, -64, 10, -6, -21, -54, 33, 64, -64, -35, 15};
b8 d8_w[96] = {103, 114, 1, 31, 76, 87, 199, 119, 173, 80, 185, 180, 209, 164, 133, 31, 65, 116, 85, 255, 96, 39, 76, 5,
               31, 69, 42, 2, 67, 4, 15, 97, 43, 114, 183, 228, 193, 250, 179, 116, 164, 75, 83, 252, 31, 66, 161, 212,
               119, 100, 59, 112, 85, 43, 205, 88, 191, 134, 122, 179, 63, 99, 246, 231, 55, 67, 241, 29, 85, 247, 210,
               189, 227, 31, 122, 82, 180, 85, 119, 179, 84, 103, 126, 112, 129, 115, 98, 119, 122, 63, 87, 177, 244,
               136, 70, 53};
b8 d11_w[32] = {253, 123, 57, 132, 162, 139, 150, 163, 33, 182, 153, 197, 69, 193, 205, 196, 225, 119, 185, 33, 170,
                254, 135, 85, 16, 77, 136, 205, 15, 197, 3, 186};
i8 d12_w[48] = {0, 23, 0, -16, -13, 25, -11, 5, 64, -38, 64, 55, -32, 28, 38, -40, -41, -3, 17, -30, 56, -25, -57, 42,
                -25, -24, -39, -16, 16, -16, 17, -20, 27, 38, -8, 64, -51, 13, -19, 18, 64, 28, 27, 17, -45, -64, -64,
                -24};
b8 d13_w[96] = {78, 243, 60, 16, 192, 127, 255, 128, 223, 78, 23, 16, 228, 18, 231, 1, 204, 225, 169, 252, 225, 249,
                207, 112, 71, 227, 56, 50, 203, 56, 177, 163, 124, 50, 172, 126, 228, 27, 42, 237, 52, 127, 50, 172,
                161, 223, 160, 223, 48, 140, 126, 189, 204, 161, 206, 56, 149, 175, 116, 231, 222, 190, 65, 178, 170,
                183, 142, 59, 204, 206, 31, 78, 50, 171, 222, 197, 227, 42, 50, 142, 193, 34, 227, 42, 228, 28, 243,
                193, 224, 127, 114, 166, 1, 202, 29, 250};
b8 u1_w[64] = {151, 220, 198, 180, 63, 90, 133, 198, 0, 144, 0, 12, 16, 0, 129, 138, 60, 170, 129, 35, 100, 149, 96,
               225, 11, 191, 8, 174, 62, 223, 68, 239, 65, 0, 78, 64, 128, 32, 218, 34, 105, 167, 118, 238, 180, 230,
               207, 175, 124, 43, 251, 11, 226, 37, 251, 41, 8, 35, 69, 10, 104, 5, 116, 33};
i8 u2_w[64] = {-9, 28, -10, -64, 6, 32, 36, 12, -41, -64, 64, 64, -41, 64, 58, 9, -8, -24, 19, 64, -6, 1, -11, 9, -10,
               -48, 64, -58, -25, -64, 33, -3, 15, 18, 31, -29, -23, -47, 8, -21, -35, -44, -29, -53, 32, 64, 64, -31,
               -12, 34, 28, 53, 48, 64, -8, 6, 64, 11, -42, 38, -40, 64, -64, -47};
b8 u3_w[64] = {56, 134, 134, 35, 122, 138, 106, 60, 251, 247, 104, 65, 154, 134, 198, 122, 234, 96, 148, 138, 70, 119,
               186, 198, 156, 24, 58, 26, 35, 134, 56, 35, 56, 198, 3, 142, 138, 97, 35, 184, 84, 114, 3, 34, 166, 56,
               138, 134, 198, 223, 198, 130, 67, 154, 114, 56, 243, 28, 34, 35, 114, 125, 51, 69};
b8 u6_w[64] = {69, 14, 163, 38, 129, 12, 1, 96, 88, 197, 217, 16, 24, 17, 254, 160, 202, 97, 174, 226, 89, 83, 230, 100,
               67, 238, 123, 182, 193, 148, 247, 108, 89, 85, 24, 195, 173, 117, 222, 214, 112, 87, 47, 238, 118, 235,
               248, 19, 74, 88, 52, 93, 102, 80, 8, 112, 182, 34, 0, 201, 75, 51, 164, 24};
i8 u7_w[32] = {-64, -3, 1, 7, -8, -7, -5, -64, -14, -20, -32, -12, 4, 11, 1, 2, 6, 2, 11, 16, -13, 64, -25, -2, 8, -64,
               9, 6, 7, -6, -21, -7};

MatI32 down(MatI32 x) {
    x = avg_pool1d_i32(x, 4, 4);               // nn.AvgPool1d(4, stride=4)
    x = conv1d_i32_i8(x, CI8(d1_w, 12, 4, 1, 1));  // QConv1d(12, 4, 1, 1, q_input_bias=False, b_weight=False),
    x = conv1d_i32_i8(x, CI8(d2_w, 4, 4, 3, 1));   // QConv1d(4, 4, 3, 1, b_weight=False),
    x = conv1d_i32_b8(x, CB8(d3_w, 4, 64, 3, 1));   // QConv1d(4, 64, 3, 1,)
    x = avg_pool1d_i32(x, 5, 5);   // QConv1d(4, 64, 3, 1,)
    x = softmax(x);
    x = conv1d_i32_b8(x, CB8(d6_w, 64, 4, 1, 1));   // QConv1d(64, 4, 1, 1,)
    x = conv1d_i32_i8(x, CI8(d7_w, 4, 4, 3, 1));   // QConv1d(4, 4, 3, 1,)
    x = conv1d_i32_b8(x, CB8(d8_w, 4, 64, 3, 1));
    x = avg_pool1d_i32(x, 3, 1);
    x = softmax(x);
    x = conv1d_i32_b8(x, CB8(d11_w, 64, 4, 1, 1));   // QConv1d(64, 4, 1, 1,)
    x = conv1d_i32_i8(x, CI8(d12_w, 4, 4, 3, 1));   // QConv1d(4, 4, 3, 1,)
    x = conv1d_i32_b8(x, CB8(d13_w, 4, 64, 3, 1));
    x = avg_pool1d_i32(x, 5, 1);
    x = softmax(x);
    return x;
}

MatI32 up(MatI32 x) {
    x = upsample_linear(x, 5, false);
    x = conv1d_i32_b8(x, CB8(u1_w, 64, 8, 1, 1));   // QConv1d(64, 4, 1, 1,)
    x = conv1d_i32_i8(x, CI8(u2_w, 8, 8, 1, 1));   // QConv1d(4, 4, 3, 1,)
    x = conv1d_i32_b8(x, CB8(u3_w, 8, 64, 1, 1));
    x = softmax(x);
    x = upsample_linear(x, 4, false);
    x = conv1d_i32_b8(x, CB8(u6_w, 64, 8, 1, 1));   // QConv1d(64, 4, 1, 1,)
    x = conv1d_i32_i8(x, CI8(u7_w, 8, 4, 1, 1));   // QConv1d(4, 4, 3, 1,)
    return x;
}

int main() {

    f32 data[1500 * 12] = {0};
    for (int i = 0; i < 12 * 1; ++i) {
        data[i] = i / 12.;
    }

    int length = 1;
    int channels = 12;

    MatI32 x = F32_2_I32(F32(data, length, channels));

    // pad
    x = pad_length_I32(x, 180, 180);                  //	x = F.pad(x, (232, 100))
    for (int i = 0; i < x.length * x.channels; ++i) x.data[i] /= 8;       // 除以8

    // down
    x = down(x);
    x = up(x);
//    f32 data2[4*3*4];
//    i8_2_f32(d2_w, data2, 4*3*4);
//    MatF32 mf = F32(data2, 4, 3*4);
//
//
    MatF32 mf = I32_2_F32(x);

    printMF32("output", mf);
    FILE *file = fopen("../data.bin", "wb");
    fwrite(mf.data, sizeof(f32), mf.length * mf.channels, file);
    fclose(file);
    return 1;
}
